
function init_icon(type, img)
{
    var icon = new GIcon();
    icon.image = "<?=fullbase();?>/images/" + img;
    icon.iconAnchor = new GPoint(12, 12);
    icon.infoWindowAnchor = new GPoint(12, 12);
    icon.iconSize = new GSize(24, 24);
    icon.shadow = "<?=fullbase();?>/images/shadow.png";
    icon.shadowSize = new GSize(30, 30);

    return icon;
}

var marker_id = {}
var map = null;

function init() {
  if (GBrowserIsCompatible()) {
    map = new GMap2(document.getElementById("map_canvas"));
    map.addControl(new GSmallMapControl());
    map.addControl(new GMapTypeControl());
    map.enableScrollWheelZoom();

    //map.setCenter(new GLatLng(37, -100), 4); //U.S. only
    map.setCenter(new GLatLng(20, 0), 2);

    GEvent.addListener(map, "infowindowclose", function() {
        $("#site option[value=]").attr("selected", "selected");
    });

    //generate icons
    var icon = {};
    var type = "ok";
    icon[type] = init_icon(type, "status_ok.png");
    type = "warning";
    icon[type] = init_icon(type, "status_warning.png");
    type = "unknown";
    icon[type] = init_icon(type, "status_unknown.png");
    type = "critical";
    icon[type] = init_icon(type, "status_critical.png");
    type = "downtime";
    icon[type] = init_icon(type, "status_downtime.png");

    function createMarker(id, point, markerOptions, html) {
      var marker = new GMarker(point, markerOptions);
      marker_id[id] = marker;
      GEvent.addDomListener(marker, "click", function() {
        marker.openInfoWindowHtml(html);
        var latlng = marker.getLatLng();
        map.panTo(latlng);
        $("#site option[value="+id+"]").attr("selected", "selected");
      });
      return marker;
    }
<?
foreach($this->sites as $site) {

    //status counter    
    $status_ok = 0;
    $status_warning = 0;
    $status_critical = 0;
    $status_unknown = 0;
    $status_downtime = 0;

    $site_id = $site->id;

    $rgs = $this->rgs[$site_id];
    if(count($rgs) == 0) continue; //don't show site with no resource group
    if($site->active == 0 || $site->disable == 1) continue; //don't show sites that are not active

    $html = "";
    foreach($rgs as $rg) {
        $rgname = $rg->name;
        if($rg->active == 0 || $rg->disable == 1) continue;
        if(uwa()) {
            $target = "target=\"_blank\"";
        } else {
            $target = "";
        }
        $gid = $rg->id;
        $html .= "<h3>Resource Group: <a $target href=\"".fullbase()."/wizardsummary?datasource=summary&rg=on&rg_$gid&summary_attrs_showdesc=on&summary_attrs_showservice=on&summary_attrs_showrsvstatus=on\">$rgname</a></h3>";
        $resource_count = 0;
        if(isset($this->resources_bygid[$rg->id])) {
            $rs = $this->resources_bygid[$rg->id];
            foreach($rs as $r) {
                if($r->active == 0 || $r->disable == 1) continue;
                if(isset($this->resource_status[$r->id][0])) {
                    $rstatus = $this->resource_status[$r->id][0];
                    $name = $r->name;
                    $status = Status::getStatus($rstatus->status_id);
                    $html .= "<div class=\"status_$status\"><h4>$name</h4>";
                    $html .= $rstatus->detail . "<br/></div>";
                } else {
                    $name = $r->name;
                    $status = "UNKNOWN";
                    $html .= "<div class=\"status_$status\"><h4>$name</h4>";
                    $html .= "Resource status is not calculated for this resource.<br/></div>";
                }

                //determine site status
                if($status == "OK") $status_ok++;
                if($status == "WARNING") $status_warning++;
                if($status == "CRITICAL") $status_critical++;
                if($status == "UNKNOWN") $status_unknown++;
                if($status == "DOWNTIME") $status_downtime++;
                
                $resource_count++;
            }
        }
        if($resource_count == 0) {
            $html .= "No active resource exists under this resource group.";
        }
    }

    //decide site status
    if($status_critical > 0) $status = "critical";
    else if($status_downtime > 0) $status = "downtime";
    else if($status_warning > 0) $status = "warning";
    else if($status_unknown > 0) $status = "unknown";
    else if($status_ok > 0) $status = "ok";
    else $status = "unknown"; //no info!?

    $html = addslashes($html);
    if($site->latitude == null) $site->latitude = 0;
    if($site->longitude == null) $site->longitude = 0;
    echo "map.addOverlay(createMarker($site_id, new GLatLng(".$site->latitude.", ".$site->longitude."), {icon:icon[\"$status\"]}, '$html'));\n";
    echo "$(\"#site\").append(\"<option value='$site_id'>$site->name</option>\");\n";
}
?>
  }
    $("#site").change(function() {
        var id = $(this).val();
        var marker = marker_id[id];
        if(marker) {
            $(marker).trigger('click');
        } else {
            map.closeInfoWindow();
        }
    });
}
